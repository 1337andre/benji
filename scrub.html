

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scrub &mdash; Benji Backup 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Restore" href="restore.html" />
    <link rel="prev" title="Backup" href="backup.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#centos-7">CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#redhat-enterprise-linux-7">Redhat Enterprise Linux 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#customise-your-configuration">Customise Your Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#benji-yaml">benji.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backup.html#simple-backup">Simple backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="backup.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#specifying-a-block-size">Specifying a Block Size</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#tag-backups">Tag Backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#export-metadata">Export Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#what-scrubbing-does-not">What Scrubbing Does Not</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scrubbing-failures">Scrubbing Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#partial-scrubbing">Partial Scrubbing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="restore.html#full-restores">Full Restores</a></li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restore-of-invalid-versions">Restore of invalid Versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="enforce.html#policy-specification">Policy Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cleanup.html#fast-cleanup">Fast Cleanup</a></li>
<li class="toctree-l3"><a class="reference internal" href="cleanup.html#full-cleanup">Full Cleanup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="administration.html#secure-your-metadata">Secure your Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#metadata-redundancy">Metadata Redundancy</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#secure-your-block-data">Secure your block data</a></li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#tips-tricks">Tips &amp; tricks</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#machine-output">Machine output</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#debugging">Debugging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#meta-backend">Meta Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#data-backend">Data Backend</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Scrub</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/scrub.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="scrub">
<span id="scrubbing"></span><h1>Scrub<a class="headerlink" href="#scrub" title="Permalink to this headline">¶</a></h1>
<p>Scrubbing backups is needed to ensure data consistency.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ benji scrub --help
usage: benji scrub [-h] [-p PERCENTILE] version_uid

positional arguments:
  version_uid           Version UID

optional arguments:
  -h, --help            show this help message and exit
  -p PERCENTILE, --percentile PERCENTILE
                        Only check PERCENTILE percent of the blocks (value
                        0..100). Default: 100
</pre></div>
</div>
<div class="section" id="reasons-for-scrubbing">
<h2>Reasons for Scrubbing<a class="headerlink" href="#reasons-for-scrubbing" title="Permalink to this headline">¶</a></h2>
<p>Benji backs up data in blocks. These blocks are referenced from the metadata
store. When restoring images, these blocks are read and restored in the order
the metadata store says. As Benji also does deduplication, an invalid block
could potentially create invalid restore data on multiple places.</p>
<p>Invalid blocks can happen in these cases (probably incomplete):</p>
<ul class="simple">
<li>Bit rot / Data degradation (<a class="reference external" href="https://en.wikipedia.org/wiki/Data_degradation">https://en.wikipedia.org/wiki/Data_degradation</a>)</li>
<li>Software failure when writing the block for the first time</li>
<li>OS errors and bugs</li>
<li>Human error: deleting or modifying blocks by accident</li>
<li>Software errors in Benji and other used tools</li>
</ul>
</div>
<div class="section" id="scrubbing-methods">
<h2>Scrubbing Methods<a class="headerlink" href="#scrubbing-methods" title="Permalink to this headline">¶</a></h2>
<p>Benji implements three different scrubbing methods:</p>
<div class="section" id="consistency-and-checksum">
<h3>Consistency and Checksum<a class="headerlink" href="#consistency-and-checksum" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji deep-scrub &lt;version_uid&gt;
</pre></div>
</div>
<p>Benji reads block-metadata (UID and checksum) from the metadata store, reads
the block by its UID from the <em>data backend</em>, calculates its checksum and
compares the checksums.</p>
</div>
<div class="section" id="using-the-backup-source">
<h3>Using the Backup Source<a class="headerlink" href="#using-the-backup-source" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji deep-scrub -s &lt;snapshot&gt; &lt;version_uid&gt;
</pre></div>
</div>
<p>Benji also reads the backup source for this version. This means that
Benji reads the block metadata (UID, position and checksum), reads the
corresponding source data block, the target block, calculates the checksum
of both, compares these checksums to the stored one and compares the source- and
data-block byte for byte.</p>
<p>This is not necessarily slower, but it will of course create some load on the
source storage, whereas target-only scrub only creates load on the target
storage.</p>
</div>
<div class="section" id="consistency-only">
<h3>Consistency Only<a class="headerlink" href="#consistency-only" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji scrub &lt;version_uid&gt;
</pre></div>
</div>
<p>Benji only checks the metadata consistency between the metadata saved in the
database and the metadata accompanying each block. It also checks if the
block exists and has the right length. The actual data is <strong>not</strong> checked.</p>
<p>This mode of operation can be a useful in addition to deep-scrubs if
you pay for data downloads or bandwidth is limited. It is not a replacement
for doing deep-scrubs but you can reduce their frequency.</p>
</div>
</div>
<div class="section" id="what-scrubbing-does-not">
<h2>What Scrubbing Does Not<a class="headerlink" href="#what-scrubbing-does-not" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Scrubbing doesn’t modify any block data on the <em>data backend</em></li>
</ul>
<p>This means it</p>
<ul class="simple">
<li>doesn’t fix filesystem errors on backed up images</li>
<li>doesn’t check for any structure within blocks</li>
<li>and doesn’t replay database journals or execute similar repair operations.</li>
</ul>
</div>
<div class="section" id="scrubbing-failures">
<h2>Scrubbing Failures<a class="headerlink" href="#scrubbing-failures" title="Permalink to this headline">¶</a></h2>
<p>If scrubbing finds invalid blocks, these blocks are marked as <em>invalid</em>
in the metadata store. However, such blocks <strong>will persist</strong> and not be deleted.</p>
<p>Also, the versions affected by such invalid blocks are marked <em>invalid</em>.
Such versions cannot be the base (i.e. <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span> <span class="pre">-f</span></code>, see
<a class="reference internal" href="backup.html#differential-backup"><span class="std std-ref">Differential Backup</span></a>) for differential backups anymore, Benji will throw
an error if you try.</p>
<p>However, invalid versions <strong>can still be restored</strong>. So a single block will not
break the restore process. Instead, you’ll get a clear log output that there
is invalid data restored.</p>
<p>You can find invalid versions by looking at the output of <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji  ls
    INFO: $ benji ls
+---------------------+-------------+------+---------------+----------+------------+-------+-----------+------+
<span class="p">|</span>         date        <span class="p">|</span>     uid     <span class="p">|</span> name <span class="p">|</span> snapshot_name <span class="p">|</span>     size <span class="p">|</span> block_size <span class="p">|</span> valid <span class="p">|</span> protected <span class="p">|</span> tags <span class="p">|</span>
+---------------------+-------------+------+---------------+----------+------------+-------+-----------+------+
<span class="p">|</span> <span class="m">2018</span>-06-07T12:51:19 <span class="p">|</span> V0000000001 <span class="p">|</span> <span class="nb">test</span> <span class="p">|</span>               <span class="p">|</span> <span class="m">41943040</span> <span class="p">|</span>    <span class="m">4194304</span> <span class="p">|</span> False <span class="p">|</span>   False   <span class="p">|</span>      <span class="p">|</span>
+---------------------+-------------+------+---------------+----------+------------+-------+-----------+------+
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Multiple versions can be affected by a single block as Benji does
deduplication and one block can belong to multiple versions, even to
different images.</p>
</div>
</div>
<div class="section" id="partial-scrubbing">
<h2>Partial Scrubbing<a class="headerlink" href="#partial-scrubbing" title="Permalink to this headline">¶</a></h2>
<p>If scrubbing all your backups creates too much load or takes too long, you can
use the <code class="docutils literal notranslate"><span class="pre">-p</span></code> parameter. With this parameter, Benji performs a
<em>partial scrub</em>. It will statistically (i.e. by random) choose the given
percentage of existing blocks in the version and scrub only these.</p>
<p>So if you call:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>benji deep-scrub -p <span class="m">15</span> &lt;version_uid&gt;
</pre></div>
</div>
<p>each day for each version, you’ll have statistically scrubbed 105% of all blocks
after seven days.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="restore.html" class="btn btn-neutral float-right" title="Restore" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="backup.html" class="btn btn-neutral" title="Backup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Daniel Kraft, Lars Fenneberg.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 


</body>
</html>