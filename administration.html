

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Administration &mdash; Benji Backup 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data Layout" href="datalayout.html" />
    <link rel="prev" title="Cleanup" href="cleanup.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#centos-7">CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#customise-your-configuration">Customise Your Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#benji-yaml">benji.yaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backup.html#simple-backup">Simple backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="backup.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#specifying-a-block-size">Specifying a Block Size</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#tag-backups">Tag Backups</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#export-metadata">Export Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scrub.html">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#what-scrubbing-does-not">What Scrubbing Does Not</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-failures">Scrubbing Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#partial-scrubbing">Partial Scrubbing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="restore.html#full-restores">Full Restores</a></li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restore-of-invalid-versions">Restore of invalid Versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a></li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cleanup.html#fast-cleanup">Fast Cleanup</a></li>
<li class="toctree-l3"><a class="reference internal" href="cleanup.html#full-cleanup">Full Cleanup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#secure-your-metadata">Secure your Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#metadata-redundancy">Metadata Redundancy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#secure-your-block-data">Secure your block data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tips-tricks">Tips &amp; tricks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#machine-output">Machine output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debugging">Debugging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#meta-backend">Meta Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#data-backend">Data Backend</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Administration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/administration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="administration">
<span id="id1"></span><h1>Administration<a class="headerlink" href="#administration" title="Permalink to this headline">¶</a></h1>
<p>Benji is an important tool when it’s responsible for company-wide backups.
Backups, scrubs, restores and cleanups must run smoothly and need to be
monitored closely.</p>
<p>Also, as Benji has two parts (<em>metadata backend and *data backend</em>), both have to
be checked regularly and be as highly-available as possible.</p>
<div class="section" id="secure-your-metadata">
<span id="administration-meta-backend"></span><h2>Secure your Metadata<a class="headerlink" href="#secure-your-metadata" title="Permalink to this headline">¶</a></h2>
<p>This section shows methods of how to keep your metadata safe even when
disasters happen.</p>
<div class="section" id="metadata-redundancy">
<h3>Metadata Redundancy<a class="headerlink" href="#metadata-redundancy" title="Permalink to this headline">¶</a></h3>
<p>Benji already exports the version metadata to the <em>data backend</em>, too. You
can restore this information with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">import-from-backend</span></code>.</p>
<p>You can also make further copies of the metadata with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">export</span></code>
and store them somewhere safe to increase your redundancy even more. It is
advisable to compress them as the JSON export format is quite verbose.</p>
<p>So now, even if your backup database server crashes, you’ll still be able
to reimport all existing versions again.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>After</strong> re-importing many versions, it is recommended to start a
<code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">cleanup</span> <span class="pre">-f</span></code> run as shown in section <a class="reference internal" href="cleanup.html#full-cleanup"><span class="std std-ref">Full Cleanup</span></a>.</p>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">When you remove (<code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">rm</span></code>) versions from the database and
then call <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">cleanup</span></code>, the blocks containing the backed up <em>data</em> will
be removed. No <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">import</span></code> can bring them back, because Benji’s export
format <em>only</em> contains metadata information.</p>
</div>
</div>
<div class="section" id="database-high-availability">
<h3>Database High-Availability<a class="headerlink" href="#database-high-availability" title="Permalink to this headline">¶</a></h3>
<p>An additional option against data loss is to replicate the SQL database. Please
refer to the database documentation. You should also have a regular database
backup in place.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">DBMS replication only helps when one server crashes or has a
failure. It does not help against software-bug related data loss, human
error and more. So <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">export</span></code> is the only reliable option for long-term
data-safety.</p>
</div>
</div>
</div>
<div class="section" id="secure-your-block-data">
<h2>Secure your block data<a class="headerlink" href="#secure-your-block-data" title="Permalink to this headline">¶</a></h2>
<p>Your <em>data backend</em> should be redundant in some way, too. Most cloud
providers have an SLA which guarantees a certain level of redundancy
and high-availability. If you manage your <em>data backend</em> yourself, then
you should look into redundancy technologies like:</p>
<ul class="simple">
<li>RAID 1, 5 and 6</li>
<li>Redundancy provided by a distributed objected store like Ceph or Minio</li>
<li>DRBD</li>
<li><dl class="first docutils">
<dt>Filesystem specific data redundancy and replication mechanisms in filesystem</dt>
<dd>like Btrs or ZFS</dd>
</dl>
</li>
</ul>
<p>If your <em>data backend</em> fails or has corruptions, at best corrupted restores will
be possible. Benji does not store any redundant data and it cannot  restore
data from stored checksums alone.</p>
</div>
<div class="section" id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tips-tricks">
<h3>Tips &amp; tricks<a class="headerlink" href="#tips-tricks" title="Permalink to this headline">¶</a></h3>
<p>You should monitor exit codes of Benji closely. Anything != 0 means: There was
a problem.</p>
<p>Benji writes all output including possible tracebacks and command lines to
the configured logfile (see <a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration</span></a>).
If anything goes wrong, you’ll be able to visit this logfile and get
enough information to troubleshoot the problem, even if this Benji call
came from an automated script.</p>
<p>You should also monitor the success of the backups. In addition to checking the
exit code, you can do this with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code> and see if the column <code class="docutils literal notranslate"><span class="pre">valid</span></code>
is True. This will be True as soon as the backup has finished successfully.</p>
<p>You can also monitor the progress of the backups either by looking at the
logfile or by checking your process-tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ps axfu|grep &quot;[b]acky2&quot;
…  \_ benji [Scrubbing Version V00000001 (0.1%)]
</pre></div>
</div>
<p>To know which backup took how long and to see how many blocks/bytes have been
read and written, you can use the <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">stats</span></code> command:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ benji stats --help
usage: benji stats [-h] [-l LIMIT] [version_uid]

positional arguments:
  version_uid           Show statistics for this version

optional arguments:
  -h, --help            show this help message and exit
  -l LIMIT, --limit LIMIT
                        Limit output to this number (default: unlimited)
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ benji stats
    INFO: $ benji stats
+---------------------+-------------+------+---------------+----------+------------+------------+-------------+---------------+----------------+-------------+--------------+--------------+---------------+--------------+
|         date        |     uid     | name | snapshot_name |   size   | block_size | bytes read | blocks read | bytes written | blocks written | bytes dedup | blocks dedup | bytes sparse | blocks sparse | duration (s) |
+---------------------+-------------+------+---------------+----------+------------+------------+-------------+---------------+----------------+-------------+--------------+--------------+---------------+--------------+
| 2018-06-07T12:51:20 | V0000000001 | test |               | 41943040 |  4194304   |   41943040 |          10 |      41943040 |             10 |           0 |            0 |            0 |             0 |           0s |
| 2018-06-08T12:26:53 | V0000000002 | test |               | 41943040 |  4194304   |   41943040 |          10 |      41943040 |             10 |           0 |            0 |            0 |             0 |           0s |
| 2018-06-08T12:26:56 | V0000000003 | test |               | 41943040 |  4194304   |   41943040 |          10 |             0 |              0 |    41943040 |           10 |            0 |             0 |           0s |
| 2018-06-08T12:26:58 | V0000000004 | test |               | 41943040 |  4194304   |   41943040 |          10 |             0 |              0 |    41943040 |           10 |            0 |             0 |           0s |
+---------------------+-------------+------+---------------+----------+------------+------------+-------------+---------------+----------------+-------------+--------------+--------------+---------------+--------------+
</pre></div>
</div>
</div>
<div class="section" id="machine-output">
<span id="id2"></span><h3>Machine output<a class="headerlink" href="#machine-output" title="Permalink to this headline">¶</a></h3>
<p>Some commands (like <code class="docutils literal notranslate"><span class="pre">ls</span></code>, <code class="docutils literal notranslate"><span class="pre">stats</span></code>, <code class="docutils literal notranslate"><span class="pre">backup</span></code> and <code class="docutils literal notranslate"><span class="pre">enforce</span></code>) can also produce
machine readable JSON output for usage in scripts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ benji -m ls
{
  &quot;metadataVersion&quot;: &quot;1.0.0&quot;,
  &quot;versions&quot;: [
    {
      &quot;uid&quot;: 1,
      &quot;date&quot;: &quot;2018-06-07T12:51:19&quot;,
      &quot;name&quot;: &quot;test&quot;,
      &quot;snapshot_name&quot;: &quot;&quot;,
      &quot;size&quot;: 41943040,
      &quot;block_size&quot;: 4194304,
      &quot;valid&quot;: true,
      &quot;protected&quot;: false,
      &quot;tags&quot;: []
    }
  ]
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Take care to put the <code class="docutils literal notranslate"><span class="pre">-m</span></code> between <code class="docutils literal notranslate"><span class="pre">benji</span></code> and <code class="docutils literal notranslate"><span class="pre">ls</span></code>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">jq</span></code> is an excellent tool for parsing this data and filtering out the bits you
want. Here’s a short example, but see the <code class="docutils literal notranslate"><span class="pre">scripts/</span></code> and <code class="docutils literal notranslate"><span class="pre">images/benji-rook/scripts</span></code>
directories for more ones:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ benji -m ls | jq -r &#39;.versions[0].date&#39;
2018-06-07T12:51:19
</pre></div>
</div>
<p>With machine readable output you can use the option <code class="docutils literal notranslate"><span class="pre">--include-blocks</span></code>
to <code class="docutils literal notranslate"><span class="pre">ls</span></code> which also includes all blocks of this version in the output.</p>
<p>Version UIDs will be represented as simple integers without V prefix
and being zero-filled. All Benji commands are able to take this
representation as well, so you can use it in further commands as-is.</p>
<p>All timestamps are in UTC and without timezone information.</p>
</div>
<div class="section" id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h3>
<p>In case something goes wrong, you can use the <code class="docutils literal notranslate"><span class="pre">-v</span></code> switch to increase the
logging verbosity. This outputs much more information.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="datalayout.html" class="btn btn-neutral float-right" title="Data Layout" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cleanup.html" class="btn btn-neutral" title="Cleanup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Daniel Kraft, Lars Fenneberg.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 


</body>
</html>